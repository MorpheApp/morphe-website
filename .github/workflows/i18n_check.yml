name: i18n Check

on:
  workflow_dispatch:
#  push:
#    branches: [ main, dev ]
#    paths:
#      - 'public/**/*.html'
#      - 'public/locales/*.json'
#      - 'scripts/**'
#  pull_request:
#    branches: [ main, dev ]
#    paths:
#      - 'public/**/*.html'
#      - 'public/locales/*.json'
#      - 'scripts/**'


jobs:
  check-translations:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Extract i18n keys from HTML
        run: npm run i18n:extract

      - name: Check for changes in en.json
        id: check_changes
        run: |
          git diff --exit-code public/locales/en.json || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Comment on PR if en.json needs update
        if: steps.check_changes.outputs.changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ The `en.json` file needs to be updated. Please run `npm run i18n:extract` and commit the changes.'
            })

      - name: Check translation completeness
        run: npm run i18n:check

      - name: Upload translation report
        if: always()
        run: |
          npm run i18n:check > translation-report.txt
          cat translation-report.txt

      - name: Comment translation status on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = 'Translation status not available';
            try {
              report = fs.readFileSync('translation-report.txt', 'utf8');
            } catch (e) {}
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Translation Status\n\n```\n' + report + '\n```'
            })

  # Crowdin sync job
#  sync-crowdin:
#    runs-on: ubuntu-latest
#    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#    needs: check-translations
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Crowdin push
#        uses: crowdin/github-action@v1
#        with:
#          upload_sources: true
#          upload_translations: false
#          download_translations: true
#          crowdin_branch_name: main
#        env:
#          CROWDIN_PROJECT_ID: ${{ secrets.CROWDIN_PROJECT_ID }}
#          CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_TOKEN }}
#
#      - name: Create Pull Request with translations
#        if: success()
#        uses: peter-evans/create-pull-request@v5
#        with:
#          token: ${{ secrets.GITHUB_TOKEN }}
#          commit-message: 'chore: update translations from Crowdin'
#          title: 'Update translations from Crowdin'
#          body: |
#            Automated PR with latest translations from Crowdin.
#
#            Please review the changes before merging.
#          branch: crowdin-translations
#          base: main
