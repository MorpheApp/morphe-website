name: i18n Check

on:
  workflow_dispatch:
  push:
    branches: [ main, dev ]
    paths:
      - 'public/**/*.html'
      - 'public/locales/*.json'
      - 'scripts/**'
  pull_request:
    branches: [ main, dev ]
    paths:
      - 'public/**/*.html'
      - 'public/locales/*.json'
      - 'scripts/**'

jobs:
  check-translations:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Extract i18n keys from HTML
        run: npm run i18n:extract

      - name: Check for changes in en.json
        id: check_changes
        run: |
          if git diff --exit-code public/locales/en.json; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Check translation completeness
        id: check_status
        run: |
          # Run check and save output
          npm run i18n:check > translation-report.txt
          cat translation-report.txt
          
          # Extract average completion
          AVG=$(grep "Average completion" translation-report.txt | grep -oP '\d+' || echo "0")
          echo "avg_completion=$AVG" >> $GITHUB_OUTPUT
          
          # Check for specific issues
          MISSING=$(grep -E "^\s+\d+/\d+ translated, [1-9]\d* missing" translation-report.txt | wc -l || echo "0")
          UNTRANSLATED=$(grep -E "^\s+\d+/\d+ translated, \d+ missing, [1-9]\d* untranslated" translation-report.txt | wc -l || echo "0")
          ZOMBIES=$(grep -E "^[a-z-]+: \d+ zombie key" translation-report.txt | wc -l || echo "0")
          
          echo "missing_count=$MISSING" >> $GITHUB_OUTPUT
          echo "untranslated_count=$UNTRANSLATED" >> $GITHUB_OUTPUT
          echo "zombie_count=$ZOMBIES" >> $GITHUB_OUTPUT
          
          # Determine if there are issues
          if [ "$AVG" -eq 100 ] && [ "$MISSING" -eq 0 ] && [ "$ZOMBIES" -eq 0 ]; then
            echo "has_issues=false" >> $GITHUB_OUTPUT
          else
            echo "has_issues=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate PR comment
        id: generate_comment
        if: github.event_name == 'pull_request'
        run: |
          AVG="${{ steps.check_status.outputs.avg_completion }}"
          HAS_ISSUES="${{ steps.check_status.outputs.has_issues }}"
          EN_CHANGES="${{ steps.check_changes.outputs.changes }}"
          MISSING="${{ steps.check_status.outputs.missing_count }}"
          ZOMBIES="${{ steps.check_status.outputs.zombie_count }}"
          
          # Start building comment
          echo "## üåê i18n Status Report" > comment.md
          echo "" >> comment.md
          
          # En.json update warning
          if [ "$EN_CHANGES" = "true" ]; then
            echo "### ‚ö†Ô∏è English Translation Base Updated" >> comment.md
            echo "" >> comment.md
            echo "The \`en.json\` file has been modified. Please run:" >> comment.md
            echo "\`\`\`bash" >> comment.md
            echo "npm run i18n:extract" >> comment.md
            echo "git add public/locales/en.json" >> comment.md
            echo "git commit -m 'chore: update en.json baseline'" >> comment.md
            echo "\`\`\`" >> comment.md
            echo "" >> comment.md
          fi
          
          # Translation status
          if [ "$HAS_ISSUES" = "false" ]; then
            echo "### ‚úÖ Translations: Perfect!" >> comment.md
            echo "" >> comment.md
            echo "**Average Completion:** ${AVG}% üéâ" >> comment.md
            echo "" >> comment.md
            echo "All translations are complete with no issues detected." >> comment.md
          else
            echo "### üìä Translations: ${AVG}% Complete" >> comment.md
            echo "" >> comment.md
          
            # Status badges
            if [ "$AVG" -ge 95 ]; then
              echo "![Status](https://img.shields.io/badge/status-excellent-success)" >> comment.md
            elif [ "$AVG" -ge 85 ]; then
              echo "![Status](https://img.shields.io/badge/status-good-yellow)" >> comment.md
            else
              echo "![Status](https://img.shields.io/badge/status-needs_work-red)" >> comment.md
            fi
            echo "" >> comment.md
          
            # Issues summary
            if [ "$MISSING" -gt 0 ]; then
              echo "- ‚ö†Ô∏è **$MISSING** missing translation(s)" >> comment.md
            fi
            if [ "$ZOMBIES" -gt 0 ]; then
              echo "- üßü **$ZOMBIES** zombie key(s) found" >> comment.md
            fi
            echo "" >> comment.md
          
            # Detailed report in collapsible section
            echo "<details>" >> comment.md
            echo "<summary>üìã View detailed report</summary>" >> comment.md
            echo "" >> comment.md
            echo "\`\`\`" >> comment.md
            cat translation-report.txt >> comment.md
            echo "\`\`\`" >> comment.md
            echo "" >> comment.md
            echo "</details>" >> comment.md
            echo "" >> comment.md
          
            # Action items
            echo "### üîß Action Items" >> comment.md
            echo "" >> comment.md
            if [ "$AVG" -lt 100 ]; then
              echo "- Complete missing translations for all locales" >> comment.md
            fi
            if [ "$ZOMBIES" -gt 0 ]; then
              echo "- Remove unused translation keys from locale files" >> comment.md
            fi
            echo "- Run \`npm run i18n:check\` locally for full details" >> comment.md
          fi
          
          # Footer
          echo "" >> comment.md
          echo "---" >> comment.md
          echo "*This report is automatically generated on every push*" >> comment.md

      - name: Find existing comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/find-comment@v3
        id: find_comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'üåê i18n Status Report'

      - name: Create or update comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: comment.md
          edit-mode: replace

      - name: Set commit status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const avg = parseInt('${{ steps.check_status.outputs.avg_completion }}');
            const hasIssues = '${{ steps.check_status.outputs.has_issues }}' === 'true';
            const enChanges = '${{ steps.check_changes.outputs.changes }}' === 'true';
            
            // Determine status
            let state, description;
            
            if (enChanges) {
              state = 'failure';
              description = '‚ùå en.json needs to be committed';
            } else if (avg === 100 && !hasIssues) {
              state = 'success';
              description = '‚úÖ All translations complete';
            } else if (avg >= 90) {
              state = 'success';
              description = `‚ö†Ô∏è ${avg}% complete - minor issues`;
            } else if (avg >= 75) {
              state = 'failure';
              description = `‚ùå ${avg}% complete - needs work`;
            } else {
              state = 'failure';
              description = `‚ùå ${avg}% complete - critical`;
            }
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: state,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${context.issue.number}`,
              description: description,
              context: 'i18n / Translation Completeness'
            });

      - name: Upload translation report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translation-report
          path: translation-report.txt
          retention-days: 30

  # Crowdin sync job (commented out - uncomment when ready)
  # sync-crowdin:
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   needs: check-translations
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Crowdin push
  #       uses: crowdin/github-action@v1
  #       with:
  #         upload_sources: true
  #         upload_translations: false
  #         download_translations: true
  #         crowdin_branch_name: main
  #       env:
  #         CROWDIN_PROJECT_ID: ${{ secrets.CROWDIN_PROJECT_ID }}
  #         CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_TOKEN }}
  #
  #     - name: Create Pull Request with translations
  #       if: success()
  #       uses: peter-evans/create-pull-request@v5
  #       with:
  #         token: ${{ secrets.GITHUB_TOKEN }}
  #         commit-message: 'chore: update translations from Crowdin'
  #         title: 'Update translations from Crowdin'
  #         body: |
  #           Automated PR with latest translations from Crowdin.
  #
  #           Please review the changes before merging.
  #         branch: crowdin-translations
  #         base: main
